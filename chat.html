<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VPlaza Chat</title>
    <link rel="icon" type="image/png" href="https://i.ibb.co/2FwztDC/nexus.png">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script src="https://cdn.scaledrone.com/scaledrone.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <style>
        /* Global styles */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            transition: all 0.3s ease;
        }

        body {
            font-family: 'Poppins', sans-serif;
            height: 100vh;
            overflow: hidden;
            position: relative;
            background-color: #000000;
            color: #ffffff;
        }

        /* Custom scrollbar styles */
        ::-webkit-scrollbar {
            width: 8px;
            background-color: #0a0a0a;
        }

        ::-webkit-scrollbar-thumb {
            background-color: #ff0000;
            border-radius: 4px;
            box-shadow: 0 0 10px #ff0000;
        }

        ::-webkit-scrollbar-thumb:hover {
            background-color: #ff3333;
        }

        /* Container and header styles */
        .container {
            position: relative;
            z-index: 10;
            display: flex;
            flex-direction: column;
            height: 100vh;
            padding: 10px 20px;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #111111;
            border-radius: 8px 8px 0 0;
            padding: 15px 20px;
            box-shadow: 0 0 15px rgba(255, 0, 0, 0.6);
            border: 1px solid #ff0000;
            margin-bottom: 5px;
        }

        .header h1 {
            font-size: 20px;
            color: #ff0000;
            font-weight: 700;
            text-shadow: 0 0 5px #ff0000;
        }

        .header-right {
            display: flex;
            align-items: center;
        }

        .user-info {
            display: flex;
            align-items: center;
            font-size: 14px;
            color: #cccccc;
            text-shadow: 0 0 2px #cccccc;
        }

        #userNameDisplay {
            font-weight: 600;
            color: #ffffff;
            margin-left: 5px;
            text-shadow: 0 0 3px #ffffff;
        }

        #logoutButton {
            margin-left: 10px;
            background: #ff0000;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 700;
            box-shadow: 0 0 10px #ff0000;
            transition: all 0.2s;
        }

        #logoutButton:hover {
            background: #ff3333;
            box-shadow: 0 0 15px #ff3333;
        }

        /* Messages and input styles */
        .messages {
            flex-grow: 1;
            overflow-y: auto;
            padding: 20px;
            background: #0a0a0a;
            border: 1px solid #ff0000;
            display: flex;
            flex-direction: column;
            gap: 5px;
            margin-bottom: 5px;
            box-shadow: inset 0 0 15px rgba(255, 0, 0, 0.3);
        }

        .message {
            padding: 10px 15px;
            border-radius: 4px;
            max-width: 100%;
            display: flex;
            align-items: flex-start;
            position: relative;
            transition: background 0.1s;
            background: #111111;
            box-shadow: 0 0 5px rgba(255, 0, 0, 0.3);
        }

        .message:hover {
            background: #1a1a1a;
            box-shadow: 0 0 10px rgba(255, 0, 0, 0.5);
        }

        .message-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin-right: 15px;
            overflow: hidden;
            border: 2px solid #ff0000;
            box-shadow: 0 0 8px rgba(255, 0, 0, 0.6);
        }

        .message-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .message-content {
            flex: 1;
        }

        .message-header {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
        }

        .message-username {
            font-weight: 700;
            color: #ff0000;
            font-size: 16px;
            margin-right: 10px;
            text-shadow: 0 0 5px #ff0000;
        }

        .message-timestamp {
            font-size: 12px;
            color: #999999;
        }

        .message-text {
            color: #ffffff;
            font-size: 14px;
            line-height: 1.4;
            word-wrap: break-word;
            text-shadow: 0 0 1px #ffffff;
        }

        .message-text .mention {
            background-color: rgba(255, 0, 0, 0.2);
            color: #ff3333;
            border-radius: 3px;
            padding: 0 2px;
            font-weight: 600;
            text-shadow: 0 0 5px #ff0000;
        }

        .input-area {
            display: flex;
            align-items: center;
            padding: 10px;
            background: #111111;
            border-radius: 0 0 8px 8px;
            border: 1px solid #ff0000;
            box-shadow: 0 0 15px rgba(255, 0, 0, 0.6);
        }

        .input-container {
            position: relative;
            flex-grow: 1;
            display: flex;
            align-items: center;
            background: #0a0a0a;
            border-radius: 20px;
            padding: 0 15px;
            border: 1px solid #ff0000;
            box-shadow: inset 0 0 5px rgba(255, 0, 0, 0.5);
        }

        .input-area input[type="text"] {
            flex-grow: 1;
            border: none;
            padding: 12px 0;
            background: transparent;
            color: #ffffff;
            font-size: 14px;
            font-family: 'Poppins', sans-serif;
        }

        .input-area input[type="text"]:focus {
            outline: none;
        }

        .input-area input[type="text"]::placeholder {
            color: #999999;
        }

        .input-actions {
            display: flex;
            align-items: center;
            margin-left: 10px;
        }

        .action-button {
            background: none;
            border: none;
            color: #ff0000;
            font-size: 20px;
            padding: 5px;
            cursor: pointer;
            margin-left: 5px;
            transition: color 0.2s;
            text-shadow: 0 0 5px #ff0000;
        }

        .action-button:hover {
            color: #ff3333;
            text-shadow: 0 0 10px #ff3333;
        }

        .send-button {
            background: #ff0000;
            color: #ffffff;
            border: none;
            border-radius: 20px;
            padding: 10px 15px;
            font-size: 14px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
            margin-left: 10px;
            box-shadow: 0 0 10px rgba(255, 0, 0, 0.6);
        }

        .send-button:hover {
            background: #ff3333;
            box-shadow: 0 0 15px rgba(255, 51, 51, 0.8);
        }

        /* Join notification styles */
        .join-notification {
            position: fixed;
            top: 70px;
            right: 20px;
            background: #111111;
            color: white;
            padding: 10px 15px;
            border-radius: 4px;
            z-index: 20;
            display: none; /* Hidden initially */
            animation: slideIn 0.3s ease;
            box-shadow: 0 0 15px rgba(255, 0, 0, 0.6);
            border: 1px solid #ff0000;
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @keyframes glowing {
            0% { box-shadow: 0 0 5px #ff0000; }
            50% { box-shadow: 0 0 20px #ff0000; }
            100% { box-shadow: 0 0 5px #ff0000; }
        }

        /* Modal styles */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 100;
        }

        .modal-content {
            background: #0a0a0a;
            padding: 30px;
            border-radius: 8px;
            text-align: center;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 0 20px rgba(255, 0, 0, 0.8);
            border: 1px solid #ff0000;
            animation: glowing 2s infinite;
        }

        .modal-content h2 {
            font-size: 24px;
            margin-bottom: 20px;
            color: #ff0000;
            font-weight: 700;
            text-shadow: 0 0 10px #ff0000;
        }

        .modal-content h3 {
            font-size: 18px;
            margin-bottom: 20px;
            color: #cccccc;
            font-weight: 600;
        }

        .modal-content input[type="text"] {
            margin: 10px 0;
            padding: 12px 15px;
            width: 100%;
            border: 1px solid #ff0000;
            border-radius: 4px;
            background: #111111;
            color: #ffffff;
            font-family: 'Poppins', sans-serif;
            box-shadow: inset 0 0 5px rgba(255, 0, 0, 0.5);
        }

        .modal-content input[type="text"]:focus {
            outline: none;
            box-shadow: inset 0 0 8px rgba(255, 0, 0, 0.7);
        }

        .modal-content button {
            padding: 12px 20px;
            background: #ff0000;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            width: 100%;
            transition: all 0.2s;
            margin-top: 15px;
            font-family: 'Poppins', sans-serif;
            font-weight: 700;
            box-shadow: 0 0 10px rgba(255, 0, 0, 0.6);
        }

        .modal-content button:hover {
            background: #ff3333;
            box-shadow: 0 0 15px rgba(255, 51, 51, 0.8);
        }

        /* Profile picture upload */
        .profile-upload {
            margin: 15px 0;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .profile-preview {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: #111111;
            margin-bottom: 15px;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            color: #ff0000;
            font-size: 30px;
            border: 1px solid #ff0000;
            box-shadow: 0 0 15px rgba(255, 0, 0, 0.6);
        }

        .profile-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .upload-button {
            background: #111111;
            color: #ffffff;
            border: 1px solid #ff0000;
            border-radius: 4px;
            padding: 8px 15px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 0 10px rgba(255, 0, 0, 0.4);
        }

        .upload-button:hover {
            background: #1a1a1a;
            box-shadow: 0 0 15px rgba(255, 0, 0, 0.6);
        }

        /* Emoji Picker styles */
        .emoji-picker {
            position: absolute;
            bottom: 80px;
            right: 20px;
            width: 340px;
            background: #1e1e1e;
            border-radius: 8px;
            box-shadow: 0 0 15px rgba(255, 0, 0, 0.8);
            border: 1px solid #ff0000;
            z-index: 100;
            display: none;
            overflow: hidden;
            flex-direction: column;
            animation: fadeIn 0.2s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .emoji-picker-tabs {
            display: flex;
            border-bottom: 1px solid #2f2f2f;
            padding: 10px;
        }

        .emoji-picker-tab {
            padding: 8px 16px;
            color: #b9bbbe;
            cursor: pointer;
            margin-right: 5px;
            border-radius: 4px 4px 0 0;
            transition: background 0.2s;
        }

        .emoji-picker-tab.active {
            color: #fff;
            background: #36393f;
        }

        .emoji-picker-search {
            padding: 10px;
            position: relative;
        }

        .emoji-picker-search input {
            width: 100%;
            padding: 10px 40px 10px 10px;
            border-radius: 8px;
            border: none;
            background: #36393f;
            color: #fff;
            font-family: 'Poppins', sans-serif;
        }

        .emoji-picker-search input:focus {
            outline: none;
        }

        .emoji-picker-search .search-icon {
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            color: #b9bbbe;
        }

        .emoji-section-title {
            padding: 8px 12px;
            font-size: 12px;
            font-weight: 700;
            color: #b9bbbe;
            display: flex;
            align-items: center;
            border-bottom: 1px solid #2f2f2f;
        }

        .emoji-section-title .section-icon {
            margin-right: 8px;
            color: #b9bbbe;
        }

        .emoji-section-title .dropdown-arrow {
            margin-left: 8px;
            font-size: 12px;
            color: #b9bbbe;
        }

        .emoji-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 8px;
            padding: 12px;
            overflow-y: auto;
            max-height: 300px;
            background-color: #2f2f2f;
        }

        .emoji-item {
            width: 48px;
            height: 48px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 28px;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .emoji-item:hover {
            background: #36393f;
        }

        .emoji-categories {
            display: flex;
            padding: 5px 10px;
            background: #2c2c2c;
            border-top: 1px solid #2f2f2f;
        }

        .emoji-category {
            padding: 8px;
            color: #b9bbbe;
            cursor: pointer;
            border-radius: 4px;
            transition: all 0.2s;
        }

        .emoji-category:hover {
            color: #fff;
            background: #36393f;
        }

        .emoji-picker-footer {
            display: flex;
            justify-content: flex-end;
            padding: 8px;
            background: #2c2c2c;
            border-top: 1px solid #2f2f2f;
        }

        .emoji-picker-btn {
            padding: 6px 12px;
            background: #ff0000;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: background 0.2s;
        }

        .emoji-picker-btn:hover {
            background: #ff3333;
        }

        /* Mobile responsiveness */
        @media (max-width: 768px) {
            .header h1 {
                font-size: 18px;
            }
        }

        @media (max-width: 480px) {
            .header {
                padding: 10px 15px;
            }

            .header h1 {
                font-size: 16px;
            }

            .message-avatar {
                width: 35px;
                height: 35px;
            }

            .message-username {
                font-size: 14px;
            }

            .message-text {
                font-size: 13px;
            }

            .top-buttons {
                top: 10px;
                right: 10px;
            }

            .top-button {
                width: 35px;
                height: 35px;
                font-size: 16px;
            }
        }
    </style>
</head>

<body>
    <!-- Login modal -->
    <div class="modal" id="loginModal" style="display: flex;">
        <div class="modal-content">
            <h2>WELCOME TO VPLAZA</h2>
            <h3>Create your profile</h3>

            <div class="profile-upload">
                <div class="profile-preview" id="profilePreview">
                    <i class="fas fa-user"></i>
                </div>
                <input type="file" id="profilePicture" accept="image/*" style="display: none;">
                <button class="upload-button" onclick="document.getElementById('profilePicture').click()">
                    <i class="fas fa-upload"></i> Upload Avatar
                </button>
            </div>

            <input type="text" id="usernameInput" placeholder="Enter your username" required aria-label="Your Name">
            <button onclick="setUsername()">START CHATTING</button>
        </div>
    </div>

    <!-- Chat container -->
    <div class="container" id="chatContainer" style="display: none;">
        <div class="header">
            <h1>VPLAZA CHAT</h1>
            <div class="user-info">
                Logged in as: <span id="userNameDisplay"></span>
                <button id="logoutButton">Logout</button>
            </div>
        </div>
        <div class="messages" id="messages"></div>
        <form class="input-area" onsubmit="return false;">
            <div class="input-container">
                <input id="messageInput" placeholder="Type a message..." type="text" required aria-label="Message Input" />
            </div>
            <div class="input-actions">
                <button class="action-button" type="button" id="emojiButton" aria-label="Add Emoji">
                    <i class="far fa-smile"></i>
                </button>
            </div>
            <button type="button" class="send-button" onclick="sendMessage()" aria-label="Send Message">
                <i class="fas fa-paper-plane"></i>
            </button>
        </form>

        <!-- Emoji Picker -->
        <div class="emoji-picker" id="emojiPicker">
            <div class="emoji-picker-tabs">
                <div class="emoji-picker-tab active">GIFs</div>
                <div class="emoji-picker-tab">Stickers</div>
                <div class="emoji-picker-tab">Emoji</div>
            </div>
            <div class="emoji-picker-search">
                <input type="text" placeholder="Find the perfect emoji">
                <div class="search-icon">
                    <i class="fas fa-search"></i>
                </div>
            </div>
            <div class="emoji-section-title">
                <span class="section-icon"><i class="fas fa-trophy"></i></span>
                TOP EMOJI IN ¬ª‚Äî‚ÄîVplaza‚Äî‚Äî‚ñ∂ | HOME SERVER
                <span class="dropdown-arrow"><i class="fas fa-chevron-down"></i></span>
            </div>
            <div class="emoji-grid">
                <div class="emoji-item" onclick="addEmoji('üî¥')">üî¥</div>
                <div class="emoji-item" onclick="addEmoji('‚ö°')">‚ö°</div>
                <div class="emoji-item" onclick="addEmoji('üß¢')">üß¢</div>
                <div class="emoji-item" onclick="addEmoji('üü™')">üü™</div>
                <div class="emoji-item" onclick="addEmoji('‚¨õ')">‚¨õ</div>
                <div class="emoji-item" onclick="addEmoji('üáª')">üáª</div>
                <div class="emoji-item" onclick="addEmoji('üêä')">üêä</div>
                <div class="emoji-item" onclick="addEmoji('‚úÖ')">‚úÖ</div>
                <div class="emoji-item" onclick="addEmoji('‚ù§Ô∏è')">‚ù§Ô∏è</div>
                <div class="emoji-item" onclick="addEmoji('üÜï')">üÜï</div>
            </div>
            <div class="emoji-section-title">
                <span class="section-icon"><i class="fas fa-star"></i></span>
                FAVORITES
                <span class="dropdown-arrow"><i class="fas fa-chevron-down"></i></span>
            </div>
            <div class="emoji-grid">
                <div class="emoji-item" onclick="addEmoji('üë§')">üë§</div>
                <div class="emoji-item" onclick="addEmoji('‚úÖ')">‚úÖ</div>
                <div class="emoji-item" onclick="addEmoji('üéÆ')">üéÆ</div>
                <div class="emoji-item" onclick="addEmoji('üîí')">üîí</div>
                <div class="emoji-item" onclick="addEmoji('üîì')">üîì</div>
                <div class="emoji-item" onclick="addEmoji('üü£')">üü£</div>
                <div class="emoji-item" onclick="addEmoji('üüß')">üüß</div>
            </div>
            <div class="emoji-categories">
                <div class="emoji-category"><i class="fas fa-clock"></i></div>
                <div class="emoji-category"><i class="fas fa-smile"></i></div>
                <div class="emoji-category"><i class="fas fa-flag"></i></div>
                <div class="emoji-category"><i class="fas fa-paw"></i></div>
                <div class="emoji-category"><i class="fas fa-hamburger"></i></div>
                <div class="emoji-category"><i class="fas fa-volleyball-ball"></i></div>
                <div class="emoji-category"><i class="fas fa-train"></i></div>
            </div>
            <div class="emoji-picker-footer">
                <button class="emoji-picker-btn">POPULAR</button>
            </div>
        </div>
    </div>

    <!-- Notification for new joined users -->
    <div class="join-notification" id="joinNotification"></div>

    <!-- Theme selection modal -->
    <div class="modal" id="themeModal" style="display: none;">
        <div class="modal-content">
            <h2>Settings</h2>
            <button class="close-button" onclick="closeThemeModal()" style="position: absolute; top: 10px; right: 10px; background: #ff0000; border: none; color: white; width: 25px; height: 25px; border-radius: 50%; font-size: 14px; line-height: 25px; text-align: center; cursor: pointer; box-shadow: 0 0 10px #ff0000;">√ó</button>

            <h3 style="color: #cccccc; margin-top: 10px; font-size: 16px;">Interface Settings</h3>
            <div style="margin-top: 15px; text-align: left; color: #cccccc;">
                <p>These settings are just for show. The real magic is in the chat!</p>
            </div>
        </div>
    </div>

    <!-- Hidden mention notification sound -->
    <audio id="mentionSound" src="audio/chatapp/ping.wav" preload="auto"></audio>

    <script>
        const CLIENT_ID = 'aSEKMcR4GsEZONob';
        const drone = new ScaleDrone(CLIENT_ID);
        let room;
        let userName = '';
        let userAvatar = null;
        const roomCode = 'vplaza'; // Fixed room code
        const userNames = {};
        let isRecording = false; // Track voice recording status
        let recognition; // Speech recognition instance

        // Check for profile image upload
        document.getElementById('profilePicture').addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    userAvatar = e.target.result;
                    document.getElementById('profilePreview').innerHTML = `<img src="${userAvatar}" alt="Profile Preview">`;
                };
                reader.readAsDataURL(file);
            }
        });

        // Check for saved username in localStorage
        window.onload = function() {
            const savedUserName = localStorage.getItem('vplazaUsername');
            const savedAvatar = localStorage.getItem('vplazaUserAvatar');

            if (savedUserName) {
                userName = savedUserName;
                if (savedAvatar) {
                    userAvatar = savedAvatar;
                }
                connectToChat();
            } else {
                document.getElementById('loginModal').style.display = 'flex';
            }
        };

        // Function to open theme modal
        document.getElementById('settingsButton').addEventListener('click', function() {
            document.getElementById('themeModal').style.display = 'flex';
        });

        function setUsername() {
            userName = document.getElementById('usernameInput').value.trim();

            if (!userName) {
                alert('Please enter a username!');
                return;
            }

            // Save username and avatar to localStorage
            localStorage.setItem('vplazaUsername', userName);
            if (userAvatar) {
                localStorage.setItem('vplazaUserAvatar', userAvatar);
            }

            connectToChat();
        }

        function connectToChat() {
            document.getElementById('loginModal').style.display = 'none';
            document.getElementById('chatContainer').style.display = 'flex';
            document.getElementById('userNameDisplay').textContent = userName;

            // Connect to Scaledrone
            room = drone.subscribe(`observable-${roomCode}`);

            room.on('open', error => {
                if (error) {
                    console.error('Error connecting to Scaledrone room:', error);
                    return;
                }
                console.log('Successfully connected to Scaledrone room');

                // Send a join message after successful connection
                setTimeout(() => {
                    sendMessage("Just joined the chat!");
                }, 1000);
            });

            room.on('error', error => {
                console.error('Scaledrone error:', error);
            });

            room.on('members', members => {
                console.log('Current members:', members);
            });

            room.on('member_join', member => {
                console.log('Member joined:', member);
            });

            // Handle incoming messages
            room.on('data', (data, member) => {
                console.log('Received message:', data, 'from member:', member);
                if (data) {
                    addMessageToList(data.text, data.name, member.id === drone.clientId, data.timestamp, data.avatar);

                    // Store user information for future reference
                    if (!userNames[data.name]) {
                        userNames[data.name] = {
                            clientId: member.id,
                            avatar: data.avatar
                        };
                        showJoinNotification(data.name);
                    }

                    // Check for mentions - play sound if current user is mentioned
                    if (member.id !== drone.clientId && data.text.includes(`@${userName}`)) {
                        playMentionSound();
                    }
                }
            });
        }

        function sendMessage(text) {
            const messageInput = document.getElementById('messageInput');
            // If text is provided from speech recognition, use it, otherwise get from input field
            const messageText = text || messageInput.value.trim();
            const timestamp = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

            if (messageText === '') return;

            messageInput.value = ''; // Clear input field

            console.log('Sending message:', messageText);

            // Publish message to the room
            drone.publish({
                room: `observable-${roomCode}`,
                message: {
                    text: messageText,
                    name: userName,
                    timestamp,
                    avatar: userAvatar
                }
            });
        }

        function formatText(text) {
            // Format links
            text = text.replace(/(https?:\/\/[^\s]+)/g, '<a href="$1" class="link" target="_blank" style="color: #ff6666; text-decoration: underline;">$1</a>');

            // Format mentions
            text = text.replace(/@(\w+)/g, '<span class="mention">@$1</span>');

            return text;
        }

        function addMessageToList(text, name, isSelf, timestamp, avatar) {
            console.log('Adding message to list:', text, name, isSelf, timestamp);

            const messages = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('message');

            // Default avatar placeholder
            let avatarHtml = '<i class="fas fa-user"></i>';

            // If user has avatar, use it
            if (avatar) {
                avatarHtml = `<img src="${avatar}" alt="${name}'s Avatar">`;
            }

            // Get current time if timestamp is not provided
            const messageTime = timestamp || new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

            // Discord-style formatting
            messageDiv.innerHTML = `
                <div class="message-avatar">
                    ${avatarHtml}
                </div>
                <div class="message-content">
                    <div class="message-header">
                        <span class="message-username">${name}</span>
                        <span class="message-timestamp">${messageTime}</span>
                    </div>
                    <div class="message-text">${formatText(text)}</div>
                </div>`;

            messages.appendChild(messageDiv);
            messages.scrollTop = messages.scrollHeight; // Auto-scroll to the latest message
        }

        function showJoinNotification(name) {
            const joinNotification = document.getElementById('joinNotification');
            joinNotification.textContent = `${name} has joined the chat`;
            joinNotification.style.display = 'block';
            setTimeout(() => {
                joinNotification.style.display = 'none';
            }, 3000);
        }

        function playMentionSound() {
            const mentionSound = document.getElementById('mentionSound');
            if (mentionSound) {
                mentionSound.volume = 0.5;
                mentionSound.play().catch(error => {
                    console.error('Audio playback failed:', error);
                });
            }
        }

        function startRecording() {
            if (!('webkitSpeechRecognition' in window)) {
                alert("Your browser does not support speech recognition.");
                return;
            }

            recognition = new webkitSpeechRecognition();
            recognition.lang = 'en-US';
            recognition.interimResults = false;
            recognition.maxAlternatives = 1;

            recognition.onstart = () => {
                isRecording = true;
                document.getElementById('micIcon').classList.remove('fa-microphone-slash');
                document.getElementById('micIcon').classList.add('fa-microphone');
            };

            recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript;
                document.getElementById('messageInput').value = transcript;
                sendMessage(transcript);
                stopRecording();
            };

            recognition.onend = () => {
                isRecording = false;
                document.getElementById('micIcon').classList.remove('fa-microphone');
                document.getElementById('micIcon').classList.add('fa-microphone-slash');
            };

            recognition.onerror = (event) => {
                console.error("Speech recognition error:", event.error);
                stopRecording();
            };

            recognition.start();
        }

        function stopRecording() {
            if (isRecording && recognition) {
                recognition.stop();
            }
        }

        document.getElementById('micButton').onclick = function() {
            if (isRecording) {
                stopRecording();
            } else {
                navigator.mediaDevices.getUserMedia({ audio: true })
                    .then(() => {
                        startRecording();
                    })
                    .catch(error => {
                        console.error("Microphone access denied:", error);
                        alert("Microphone access is required for voice input.");
                    });
            }
        };

        // Handle logout
        document.getElementById('logoutButton').addEventListener('click', function() {
            localStorage.removeItem('vplazaUsername');
            localStorage.removeItem('vplazaUserAvatar');
            document.getElementById('loginModal').style.display = 'flex';
            document.getElementById('chatContainer').style.display = 'none';
            userName = '';
            userAvatar = null;
            document.getElementById('usernameInput').value = '';
            document.getElementById('profilePreview').innerHTML = '<i class="fas fa-user"></i>';
        });

        function closeThemeModal() {
            document.getElementById('themeModal').style.display = 'none';
        }

        // Allow sending message with Enter key
        document.getElementById('messageInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        // Handle emoji picker functionality
        document.getElementById('emojiButton').addEventListener('click', function() {
            const emojiPicker = document.getElementById('emojiPicker');
            emojiPicker.style.display = emojiPicker.style.display === 'flex' ? 'none' : 'flex';
        });

        // Close emoji picker when clicking outside
        document.addEventListener('click', function(event) {
            const emojiPicker = document.getElementById('emojiPicker');
            const emojiButton = document.getElementById('emojiButton');

            if (!emojiPicker.contains(event.target) && event.target !== emojiButton && !emojiButton.contains(event.target)) {
                emojiPicker.style.display = 'none';
            }
        });

        // Add emoji to message input
        function addEmoji(emoji) {
            const messageInput = document.getElementById('messageInput');
            messageInput.value += emoji;
            messageInput.focus();
        }
    </script>
</body>
</html>
